# 第12題. 人氣文章

版型跟第11題差不多，主要設計有以下幾點：

1. 一樣有分頁功能（limit一次5筆），包含分頁導覽。
2. 左邊為標題區，右邊為縮文區。全文使用浮動視窗顯示（偷第一題的JS來用\)
3. 顯示讚統計
4. 登入者提供讚功能

這題稍微複雜些，主要是需要select後跑foreach的位置在版型內部。以及foreach內需要混和不少題目動作。難度還可以且代碼也不算多，就比較需要理解每一小段的用途。像是limit的列表、讚功能與登入者、分頁、分頁導覽。以及一些細節上的顯示調整。

---

# 新增pop.php\(參考news.php\)

### 1. 列表5筆 + 分頁導覽 + 讚功能

除了縮文與全文的表現方式會特別解釋，其他這裡不再細部解析三段代碼，直接調整到適合的版型。

另外調整一下現有的資料：

1. 調整select的order by num desc
2. 先調整成$newstext=$row\['text'\]，我們之後再來處理這點
3. $goodbtn這個變數移動到題目指定墜
4. 多了$row\['num'\]顯示統計值，記得放入圖片02B03.jpg

```php
<fieldset>
<legend>目前位置:首頁＞人氣文章區</legend>
<table width=100% bgcolor=#fff cellpadding=10>
    <tr><td width="25%">標題</td><td width="50%">內容</td><td>人氣</td></tr>
<?php
$nowpage=(empty($_GET['page']))?1:$_GET['page'];
$begin=($nowpage-1)*5;
$result=select("t7_blog","dpy=1 order by num desc limit ".$begin.",5");
foreach($result as $row){
    $newstext=$row['text'];
    $goodbtn="";
    if(!empty($_SESSION['user'])){
        $check=select("t11_good","user='".$_SESSION['user']."' and blog=".$row['id']);
        if($check!=null) $goodbtn=' | <a href="api.php?do=subgood&id='.$row['id'].'">收回讚</a>';
        else $goodbtn=' | <a href="api.php?do=addgood&id='.$row['id'].'">讚</a>';
    }
?> 
    <tr>
        <td bgcolor="#ffc"><?=$row['title']?></td>
        <td><?=$newstext?></td>
        <td><?=$row['num']?>個人說<img src="img/02B03.jpg" width=20><?=$goodbtn?></td>
    </tr>
<?php
}
?>
</table>
<?php
$result=page_link("t7_blog","dpy=1",5,$nowpage);
foreach($result as $name=>$data)
    echo '<a href="?do=pop&page='.$data.'">'.$name.'</a>';
?>
</fieldset>
```

以上你已經完成80%要求

---

### 2. 浮動視窗

去偷第一題的JS，就放在01P02.htm\(首頁\)的最新消息那裏包含JS，整理一下段落後放置到你本頁的最後先分析需要的code在哪裡

```php
<div style="width:95%; padding:2px; height:190px; margin-top:10px; padding:5px 10px 5px 10px; border:#0C3 dashed 3px; position:relative;">
    <span class="t botli">最新消息區</span>
    <ul class="ssaa" style="list-style-type:decimal;"></ul>
    <div id="altt" style="position: absolute; width: 350px; min-height: 100px; background-color: rgb(255, 255, 204); top: 50px; left: 130px; z-index: 99; display: none; padding: 5px; border: 3px double rgb(255, 153, 0); background-position: initial initial; background-repeat: initial initial;"></div>
    <script>
    $(".ssaa li").hover(function (){
        $("#altt").html("<pre>"+$(this).children(".all").html()+"</pre>");
        $("#altt").show();
    });
    $(".ssaa li").mouseout(function(){
        $("#altt").hide();
    });
    </script>
</div>
```

題外話的去解釋這段。大致重點為：滑到觸發對象時\(class=ssaa li\)，div\#altt會顯示出來，並同時抓取觸發對象的內部class=all之內容。所以我們改一下HTMLL跟JS：

在每個迴圈裡面的文字部分：

```php
$newstext='
    <div class="ssaa">
        '.mb_substr($row['text'],0,30).'...
        <div class="all" style="display:none">'.$row['text'].'</div>
    </div>
';
```

浮動視窗與JS放在任何地方像是頁尾處，調整後的特效DIV+JS為

```java
<div id="altt" style="position: absolute; width: 350px; min-height: 100px; background-color: rgb(255, 255, 204); top: 50px; left: 130px; z-index: 99; display: none; padding: 5px; border: 3px double rgb(255, 153, 0); background-position: initial initial; background-repeat: initial initial;"></div>
<script>
$(".ssaa").hover(function (){
    $("#altt").html("<pre>"+$(this).children(".all").html()+"</pre>")
    $("#altt").show()
})
$(".ssaa").mouseout(function(){
    $("#altt").hide()
})
</script>
```

總結整步驟完整代碼為：

```php
<fieldset>
<legend>目前位置:首頁＞人氣文章區</legend>
<table width=100% bgcolor=#fff cellpadding=10>
    <tr><td width="25%">標題</td><td width="50%">內容</td><td>人氣</td></tr>
<?php
$nowpage=(empty($_GET['page']))?1:$_GET['page'];
$begin=($nowpage-1)*5;
$result=select("t7_blog","dpy=1 order by num desc limit ".$begin.",5");
foreach($result as $row){
    $newstext='<div class="ssaa">'.mb_substr($row['text'],0,30).'...<div class="all" style="display:none">'.$row['text'].'</div></div>';
    $goodbtn="";
    if(!empty($_SESSION['user'])){
        $check=select("t11_good","user='".$_SESSION['user']."' and blog=".$row['id']);
        if($check!=null) $goodbtn=' | <a href="api.php?do=subgood&id='.$row['id'].'">收回讚</a>';
        else $goodbtn=' | <a href="api.php?do=addgood&id='.$row['id'].'">讚</a>';
    }
?> 
    <tr>
        <td bgcolor="#ffc"><?=$row['title']?></td>
        <td><?=$newstext?></td>
        <td><?=$row['num']?>個人說<img src="img/02B03.jpg" width=20><?=$goodbtn?></td>
    </tr>
<?php
}
?>
</table>
<?php
$result=page_link("t7_blog","dpy=1",5,$nowpage);
foreach($result as $name=>$data)
    echo '<a href="?do=pop&page='.$data.'">'.$name.'</a>';
?>
</fieldset>
<div id="altt" style="position: absolute; width: 350px; min-height: 100px; background-color: rgb(255, 255, 204); top: 50px; left: 130px; z-index: 99; display: none; padding: 5px; border: 3px double rgb(255, 153, 0); background-position: initial initial; background-repeat: initial initial;"></div>
<script>
$(".ssaa").hover(function (){
    $("#altt").html("<pre>"+$(this).children(".all").html()+"</pre>")
    $("#altt").show()
})
$(".ssaa").mouseout(function(){
    $("#altt").hide()
})
</script>
```



