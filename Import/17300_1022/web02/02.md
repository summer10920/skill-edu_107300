# 建立常用函式

1. 本篇做題採用PDO的資料庫連結方式，雖然較難記憶。但透過建立一次Function就能快速直覺使用。
2. 建立sql.php，將所有function寫在此檔，方便之後於網頁做inclue使用

---

# 建立sql.php

1. 記得利用90分鐘先做好此檔案。
2. 前半段主要是提供insert、update、delete、select等應用。盡可能完成前段內容。這能公用到四個題目
3. 後半段不太需要依賴前90分鐘完成，主要是提供各題目前台使用，減省兩次include。
4. 本代碼說明會提供前半段\(公用函式\)與後半段\(題目2函式\)檢視

```php
<?php
//  更改時區
date_default_timezone_set('Asia/Taipei');
//  SQL連結之物件 註1
$dblink=new PDO("mysql:host=127.0.0.1;dbname=php_v2q2;charset=utf8","root","");
//open session;
session_start();
// php轉址
function plo($link){
    return header("location:".$link);
}
// JS轉址
function jlo($link){
    return "location.href='".$link."'";
}
//select SQL
function select($table,$where){    //TABLE名稱,條件
    global $dblink;
    return $dblink->query("SELECT * FROM ".$table." WHERE ".$where)->fetchAll();
}
//分頁導覽 註2
function page_link($table,$where,$range,$now_page){            //TABLE名稱,條件,單頁範圍比數,目前頁碼
    $total=count(select($table,$where));                    //計算該table有多少筆總數
    $many=ceil($total/$range);                                //總頁數為 總數除以單頁範圍，無條件進位(ceil)
    $page_nav['<']=($now_page==1)?1:$now_page-1;            //左箭頭的頁碼依目前頁有不同定義，不是1就是少1
    for($i=1;$i<=$many;$i++) $page_nav[$i]=$i;                //一連串的數字與頁碼定義
    $page_nav['>']=($now_page==$many)?$now_page:$now_page+1;    //左箭頭的頁碼依目前頁有不同定義，不是1就是少1
    return $page_nav;
}
//insert SQL單筆 註3
function insert($ary,$table){    //陣列,TABLE名稱
    global $dblink;
    $table_name="id";
    $table_val="null";
    foreach($ary as $name=>$value){
        $table_name.=",".$name;
        $table_val.=",'".$value."'";
    }
    $dblink->exec("INSERT INTO ".$table." (".$table_name.") VALUES(".$table_val.")");
    return $dblink->lastInsertId();    //取得這筆的ID回傳
}
//update SQL 註4
function update($ary,$table){
    global $dblink;
    foreach($ary as $name=>$data){
        switch($name){
            case 'dpy': //dpy的前端必須先對所有ID對象設定$value=0 or 1
                foreach($data as $idx=>$value)        //$idx=索引,$value=0 or 1
                    $dblink->exec("UPDATE ".$table." SET dpy=".$value." WHERE id=".$idx);    //指定的變1
            break;
            case 'once':
                $dblink->exec("UPDATE ".$table." SET once='".$data."' WHERE 1");
            break;
            case 'num+1':
                $dblink->exec("UPDATE ".$table." SET num=num+1 WHERE id=".$data);
            break;
            case 'num-1':
                $dblink->exec("UPDATE ".$table." SET num=num-1 WHERE id=".$data);
            break;
            default:
                foreach($data as $idx=>$value)
                    $dblink->exec("UPDATE ".$table." SET ".$name."='".$value."' WHERE id=".$idx);
            break;
        }
    }
}
//delete SQL
function delete($ary,$table){
    global $dblink;
    foreach($ary as $name=>$data){
        switch($name){
            case 'del':
                if(!is_array($data))
                    $dblink->exec("DELETE  FROM ".$table." WHERE id=".$data);
                else
                    foreach($data as $idx)
                        $dblink->exec("DELETE  FROM ".$table." WHERE id=".$idx);
            break;
            case 'delat':
                $dblink->exec("DELETE  FROM ".$table." WHERE ".$data);
            break;
        }
    }
}
//add file    單筆，不要整個$_FILES丟過來
function addfile($file){
    $name=date("YmdHis")."_".$file["name"];
    copy($file["tmp_name"],"upload/".$name);
    return $name;
}
?>
<?php
/***********************Q2***********************/
//t3
$t3today=date("m月d號 l");    //今日日期
if(empty($_SESSION['visit'])){    //新訪客時
    $_SESSION['visit']=123;
    $result=select("t3_visit","date='".date("Y-m-d")."'");
    if($result==null){    //如果找不到今天資料則新增一筆今日，同時宣告拜訪數為1
        $ary['date']=date("Y-m-d");
        $ary['num']=1;
        insert($ary,"t3_visit");
        $_SESSION['visit_num']=1;//拜訪數回存
    }
    else{
        $ary['num+1']=$result[0]['id'];//更新拜訪數+1
        update($ary,"t3_visit");
        $_SESSION['visit_num']=$result[0]['num']+1;//剛取得的拜訪數+1回存
    }
}
$result=select("t3_visit",1);
$t3total=0;
foreach($result as $row) $t3total+=$row['num'];//計算所有拜訪數總值
//t4
$admin_active=(!empty($_SESSION['user'])&&$_SESSION['user']=='admin')?"admin_main":"main";
$content_zone=(empty($_GET['do']))?$admin_active:$_GET['do'];
//t6
$t6userbtn=(empty($_SESSION['user']))?'<a href="?do=login">會員登入</a>':'歡迎，'.$_SESSION['user'].' <a style="border: solid 1px #000000" href="api.php?do=logout">登出</a>';
//t14
$usermenu='
<a class="blo" href="?do=po">分類網誌</a>
<a class="blo" href="?do=news">最新文章</a>
<a class="blo" href="?do=pop">人氣文章</a>
<a class="blo" href="#">講座訊息</a>
<a class="blo" href="?do=que">問卷調查</a>
';
$adminmenu='
<a class="blo" href="?do=admin_user">帳號管理</a>
<a class="blo" href="#">分類網誌</a>
<a class="blo" href="?do=admin_news">最新文章管理</a>
<a class="blo" href="#">講座管理</a>
<a class="blo" href="?do=admin_que">問卷調查</a>
';
$menu=(!empty($_SESSION['user'])&&$_SESSION['user']=='admin')?$adminmenu:$usermenu;
?>
```



