# 第11題. 最新文章

這題設計要點比較多，分為幾個重點

1. 分頁功能（limit一次5筆），包含分頁導覽。
2. 左邊為標題區，右邊為內容區。內容區可能是縮文或是全文\(利用$\_GET\['id'\]是否同該文章ID來處理\)。
3. 登入者提供讚功能

---

# 建立news.php

### 1. 列表5筆 + 分頁導覽 + 縮文or全文

列表五筆的重點代碼

```php
$nowpage=(empty($_GET['page']))?1:$_GET['page'];
$begin=($nowpage-1)*5;
$result=select("t7_blog","dpy=1 limit ".$begin.",5");
foreach($result as $row){
    <tr>
        <td bgcolor="#ffc"><?=$row['title']?></td>
        <td><?=$row['text']?></td>
    </tr>
}
```

分頁導覽的重點代碼

```php
$result=page_link("t7_blog","dpy=1",5,$nowpage);
foreach($result as $name=>$data)
    echo '<a href="?do=news&page='.$data.'">'.$name.'</a>';
```

縮文or全文的重點代碼。

1. 如果GET\['id'\]存在且同等於本行的ID，那就是全文
2. 否則，顯示縮文並自帶超連結夾帶id，記得保留page值

```php
if(!empty($_GET['id'])&&$_GET['id']==$row['id']) $newstext=$row['text'];
else $newstext='<a href="?do=news&page='.$nowpage.'&id='.$row['id'].'">'.mb_substr($row['text'],0,30).'...</a>';
```

合併起來為以下\($newstext取代原本位置\)

```php
<fieldset>
<legend>目前位置:首頁＞最新文章區</legend>
<table width=100% bgcolor=#fff cellpadding=10>
    <tr><td width="25%">標題</td><td>內容</td></tr>
<?php
$nowpage=(empty($_GET['page']))?1:$_GET['page'];
$begin=($nowpage-1)*5;
$result=select("t7_blog","dpy=1 limit ".$begin.",5");
foreach($result as $row){
    if(!empty($_GET['id'])&&$_GET['id']==$row['id']) $newstext=$row['text'];
    else $newstext='<a href="?do=news&page='.$nowpage.'&id='.$row['id'].'">'.mb_substr($row['text'],0,30).'...</a>';
?> 
    <tr>
        <td bgcolor="#ffc"><?=$row['title']?><?=$goodbtn?></td>
        <td><?=$newstext?></td>
    </tr>
<?php
}
?>
</table>
<?php
$result=page_link("t7_blog","dpy=1",5,$nowpage);
foreach($result as $name=>$data)
    echo '<a href="?do=news&page='.$data.'">'.$name.'</a>';
?>
</fieldset>
```

---

### 2. 登入的讚功能顯示

先設計一個變數為$goodbtn。判斷使用者如果已登入，檢查是否\[user name\] vs \[blog id\]有紀錄

1. 有，設計收回讚反應
2. 沒有，設計讚反應

```php
$goodbtn="";
if(!empty($_SESSION['user'])){
    $check=select("t11_good","user='".$_SESSION['user']."' and blog=".$row['id']);
    if($check!=null) $goodbtn=' | <a href="api.php?do=subgood&id='.$row['id'].'">收回讚</a>';
    else $goodbtn=' | <a href="api.php?do=addgood&id='.$row['id'].'">讚</a>';
}
```

這段代碼要放在前步驟的迴圈內\(為了取得$row\['id'\]\)，整合起來變成

```php
<fieldset>
<legend>目前位置:首頁＞最新文章區</legend>
<table width=100% bgcolor=#fff cellpadding=10>
    <tr><td width="25%">標題</td><td>內容</td></tr>
<?php
$nowpage=(empty($_GET['page']))?1:$_GET['page'];
$begin=($nowpage-1)*5;
$result=select("t7_blog","dpy=1 limit ".$begin.",5");
foreach($result as $row){
    if(!empty($_GET['id'])&&$_GET['id']==$row['id']) $newstext=$row['text'];
    else $newstext='<a href="?do=news&page='.$nowpage.'&id='.$row['id'].'">'.mb_substr($row['text'],0,30).'...</a>';
    $goodbtn="";
    if(!empty($_SESSION['user'])){
        $check=select("t11_good","user='".$_SESSION['user']."' and blog=".$row['id']);
        if($check!=null) $goodbtn=' | <a href="api.php?do=subgood&id='.$row['id'].'">收回讚</a>';
        else $goodbtn=' | <a href="api.php?do=addgood&id='.$row['id'].'">讚</a>';
    }
?> 
    <tr>
        <td bgcolor="#ffc"><?=$row['title']?><?=$goodbtn?></td>
        <td><?=$newstext?></td>
    </tr>
<?php
}
?>
</table>
<?php
$result=page_link("t7_blog","dpy=1",5,$nowpage);
foreach($result as $name=>$data)
    echo '<a href="?do=news&page='.$data.'">'.$name.'</a>';
?>
</fieldset>
```

---

# 增添api.php

### 4. 讚功能

兩個動作是對文章的num修改數字，num+1跟num-1函式庫那裏會自動+1-1。

對資料表t11\_good做新增或刪除當作對應的讚紀錄。delat是自訂刪除條件而不是靠索引。

```php
case 'addgood':
    $post['user']=$_SESSION['user'];
    $post['blog']=$_GET['id'];
    insert($post,"t11_good");
    $readd['num+1']=$_GET['id'];
    update($readd,"t7_blog");
    echo "<script>window.history.back()</script>";
break;
case 'subgood':
    $post['delat']="user='".$_SESSION['user']."' and blog=".$_GET['id'];
    delete($post,"t11_good");
    $readd['num-1']=$_GET['id'];
    update($readd,"t7_blog");
    echo "<script>window.history.back()</script>";
break;
```



