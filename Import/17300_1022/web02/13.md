# 第13題.問卷調查

問卷有三種不同畫面需求，分別是初始畫面，投票畫面，結果畫面。這裡透過GET參數做switch對應指向。

---

# 新增que.php

### 1. 規劃可三種畫面的切換功能

這題分為三種版型，分別是初始畫面，投票畫面，結果畫面。根據GET參數做對應指向。規劃switch來區分這三組畫面

```php
<?php
$layout=0;
if(!empty($_GET['vote'])) $layout=1;
if(!empty($_GET['show'])) $layout=2;
switch ($layout) {
    case 0:
    break;
    case 1:
    break;
    case 2:
    break;
}
?>
```

---

### 2. 初始畫面

先規劃一開始的內容畫面，可以從pop.php複製過來開始調整。初始畫面位置在case 0內：

1. 超連結處前往到本頁面，夾帶以下可能GET值  
   case 1：vote=id，title=標題  
   case 2：show=id，title=標題，以及$total總數也送過去

2. 有無登入利用變數$votebtn去反應，塞入判別式

以下為初始版型且可撈取問卷主題與編號排序

```php
case 0:
        ?>
        <fieldset>
        <legend>目前位置:首頁＞問卷調查</legend>
        <table width=100%>
            <tr><td>編號</td><td>問卷題目</td><td>投票總數</td><td>結果</td><td>狀態</td></tr>
        <?php
        $result=select("t13_vote","parent=0");
        foreach($result as $row){
            $check=select("t13_vote","parent=".$row['id']);
            $total=0;
            foreach($check as $num) $total+=$num['num'];

            $votebtn=(empty($_SESSION['user']))?"請先登入":"<a href='?do=que&vote=".$row['id']."&title=".$row['text']."'>參與投票</a>"
        ?> 
            <tr>
                <td><?=$row['id']?></td>
                <td><?=$row['text']?></td>
                <td><?=$total?></td>
                <td><a href="?do=que&show=<?=$row['id']?>&title=<?=$row['text']?>&total=<?=$total?>">結果</a></td>
                <td><?=$votebtn?></td>
            </tr>
        <?php
        }
        ?>
        </table>
        </fieldset>
        <?php
break;
```

---

### 2. 投票版面

對case 1設計投票畫面，從GET取的parent值。之後提交到api.php?do=vote處理form。

```php
case 1:
    ?>
    <fieldset>
    <legend>目前位置:首頁＞問卷調查＞<?=$_GET['title']?></legend>
    <h3><?=$_GET['title']?></h3>
    <form action="api.php?do=vote" method="post">
    <?php
    $result=select("t13_vote","parent=".$_GET['vote']);
    foreach($result as $row) echo '<input type="radio" name="num+1" value='.$row['id'].'>'.$row['text'].'<br>';
    ?>
    <input type="submit" value="我要投票">
    </form>
    </fieldset>

    <?php
break;
```

注意一下這裡用name=num+1並值為ID

# 增添api.php

```php
case 'vote':
    update($_POST,"t13_vote");
    plo("index.php?do=que");
break;
```

---

### 3. 結果版面

這時候手動模擬登入帳號做一些投票動作，讓資料有些數據方便設計檢查結果畫面。重點在百分比的設計。

規劃一個div。高度為1em，寬度為$pse，以及做inline-block。table稍微排版一下跟示意圖相近

$pse為百分比，有可能當total為0會無法當分母，所以要加個判斷式。數學算法為$row\['num'\]除$\_GET\['total'\]乘100

```php
case 2:
        ?>
        <fieldset>
        <legend>目前位置:首頁＞問卷調查＞<?=$_GET['title']?></legend>
        <h3><?=$_GET['title']?></h3>
        <ol>
        <table cellpadding=10>
        <?php
        $result=select("t13_vote","parent=".$_GET['show']);
        foreach($result as $row) {
            $pse=($_GET['total']!=0)?($row['num']/$_GET['total']*100):0;
        ?>
            <tr>
                <td width=400><li><?=$row['text']?></li></td>
                <td><div style="width:<?=$pse?>px;height:1em;background:#222;display:inline-block;"></div><?=$row['num']?>票 (<?=$pse?>%)</td>
            </tr>
        <?php
        }
        ?>
        </table>
        </ol>
        </fieldset>
        <?php
break;
```



